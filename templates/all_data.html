<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Chilli - Svi podaci</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
<div id="theme-switcher">🌙</div>
<div class="container-fluid">
  <a href="/" class="btn btn-outline-secondary mt-3 mb-3">Povratak na glavnu ploču</a>
  <h2 class="mb-4">📊 Svi podaci iz baze</h2>

  <div class="mb-4">
    <label for="whereInput" class="form-label">Filter podataka (SQL WHERE uvjet, npr. <code>soil_percent &gt; 40</code>):</label>
    <div class="input-group">
      <input type="text" id="whereInput" class="form-control" value="" placeholder="npr. air_temp > 25 AND lux < 1000">
      <button id="applyFilterBtn" class="btn btn-primary">Primijeni filter</button>
    </div>
	<small class="form-text text-muted mb-1">Primjeri WHERE uvjeta:</small>
	<div class="d-flex flex-wrap gap-2 mb-3">
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="id &gt; 1000">id &gt; 1000</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="air_temp &gt; 25">air_temp &gt; 25</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="soil_percent &lt; 30">soil_percent &lt; 30</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="lux &lt; 500">lux &lt; 500</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="stable = 0">stable = 0</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" id="dateRangeBtn">zadnjih 30 dana</button>
	</div>
  </div>

  <canvas id="airTempChart"></canvas>
  <canvas id="airHumidityChart"></canvas>
  <canvas id="soilTempChart"></canvas>
  <canvas id="soilMoistureChart"></canvas>
  <canvas id="luxChart"></canvas>

  <div class="card mb-4">
    <div class="card-body">
      <h5>📈 Statistika</h5>
      <pre id="stats"></pre>
    </div>
  </div>

  <h5 class="mt-3">Brisanje podataka</h5>
  <div class="input-group mb-2">
    <input id="deleteIdsInput" type="text" class="form-control" placeholder="ID-evi npr: 1,2,3 ili 'all'">
    <button class="btn btn-danger" id="btnDeleteRows">Obriši</button>
  </div>
  <div id="deleteStatus" class="text-muted small"></div>

  <h4 class="mt-4">Tablica svih podataka</h4>
  <div class="table-container" style="max-height:60vh; overflow:auto;">
    <table class="table table-striped table-sm">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Vrijeme</th><th>Air T</th><th>Air H</th>
          <th>Soil T</th><th>Soil %</th><th>Lux</th><th>Stable</th>
        </tr>
      </thead>
      <tbody id="logsBody"></tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ------- Logika za promjenu teme (kopirano iz main.js) -------
    const themeSwitcher = document.getElementById('theme-switcher');
    const docHtml = document.documentElement;
    let registeredCharts = [];

    function updateAllChartColors() {
        const theme = docHtml.getAttribute('data-theme') || 'light';
        const isDark = theme === 'dark';
        const gridColor = getComputedStyle(docHtml).getPropertyValue('--chart-grid-color').trim();
        const labelColor = getComputedStyle(docHtml).getPropertyValue('--chart-label-color').trim();
        const chartColors = {
            airTemp: { border: isDark ? '#58a6ff' : '#0d6efd', bg: 'rgba(88, 166, 255, 0.2)' },
            soilTemp: { border: isDark ? '#56d364' : '#198754', bg: 'rgba(86, 211, 100, 0.2)' },
            airHum: { border: isDark ? '#e3b341' : '#ffc107', bg: 'rgba(227, 179, 65, 0.2)' },
            soilPercent: { border: isDark ? '#d2a679' : '#8B4513', bg: 'rgba(210, 166, 121, 0.2)' },
            lux: { border: isDark ? '#c991e1' : '#800080', bg: 'rgba(201, 145, 225, 0.2)' },
        };
        const getColor = (label) => {
            if (label.includes('Air Temperature')) return chartColors.airTemp;
            if (label.includes('Soil Temperature')) return chartColors.soilTemp;
            if (label.includes('Air Humidity')) return chartColors.airHum;
            if (label.includes('Soil Moisture')) return chartColors.soilPercent;
            if (label.includes('Lux')) return chartColors.lux;
            return { border: 'gray', bg: 'rgba(128,128,128,0.1)' };
        };
        registeredCharts.forEach(chart => {
            if (chart.options.scales.x) { chart.options.scales.x.grid.color = gridColor; chart.options.scales.x.ticks.color = labelColor; }
            if (chart.options.scales.y) { chart.options.scales.y.grid.color = gridColor; chart.options.scales.y.ticks.color = labelColor; }
            if (chart.options.plugins.legend) { chart.options.plugins.legend.labels.color = labelColor; }
            chart.data.datasets.forEach(dataset => {
                const colors = getColor(dataset.label);
                dataset.borderColor = colors.border;
                dataset.backgroundColor = colors.bg;
            });
            chart.update();
        });
    }

    function setTheme(theme) {
        docHtml.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeSwitcher.textContent = theme === 'dark' ? '☀️' : '🌙';
        updateAllChartColors();
    }

    themeSwitcher.addEventListener('click', () => {
        const currentTheme = docHtml.getAttribute('data-theme') || 'light';
        setTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // ------- Logika specifična za ovu stranicu -------
    let charts = [];

    async function fetchData() {
      const where = document.getElementById('whereInput').value.trim();
      const url = where ? `/api/logs/all?where=${encodeURIComponent(where)}` : '/api/logs/all';
      const r = await fetch(url);
      if (!r.ok) {
          alert("Greška pri dohvaćanju podataka. Provjerite SQL filter.");
          return [];
      }
      return await r.json();
    }

    function clearCharts() {
      charts.forEach(chart => chart.destroy());
      charts = [];
      registeredCharts = []; // Isprazni i registrirane grafikone
    }

    function calcStats(data) {
        if (data.length === 0) return {};
        const avg = arr => arr.length > 0 ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
        return {
            air_temp: avg(data.map(r => r.air_temp).filter(v => v!==null)),
            air_humidity: avg(data.map(r => r.air_humidity).filter(v => v!==null)),
            soil_temp: avg(data.map(r => r.soil_temp).filter(v => v!==null)),
            soil_percent: avg(data.map(r => r.soil_percent).filter(v => v!==null)),
            lux: avg(data.map(r => r.lux).filter(v => v!==null))
        };
    }

    function formatTime(ts) {
        if (!ts) return "";
        const parts = ts.split('_');
        if (parts.length < 2) return ts;
        const [date, time] = parts;
        const [y, m, d] = date.split('-');
        const [hh, mm] = time.split('-');
        return `${d}.${m}.${y.slice(-2)} ${hh}:${mm}`;
    }

    function makeChart(id, label, labels, data) {
      const ctx = document.getElementById(id).getContext('2d');
      const chart = new Chart(ctx, {
        type:'line', data:{ labels:labels, datasets:[{label:label, data:data, tension:0.2, fill:true}]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
      charts.push(chart);
      registeredCharts.push(chart);
    }

    async function loadData() {
      const data = await fetchData();
      clearCharts();
      const labels = data.map(r => formatTime(r.timestamp));
      makeChart('airTempChart', 'Air Temperature (°C)', labels, data.map(r => r.air_temp));
      makeChart('airHumidityChart', 'Air Humidity (%)', labels, data.map(r => r.air_humidity));
      makeChart('soilTempChart', 'Soil Temperature (°C)', labels, data.map(r => r.soil_temp));
      makeChart('soilMoistureChart', 'Soil Moisture (%)', labels, data.map(r => r.soil_percent));
      makeChart('luxChart', 'Lux', labels, data.map(r => r.lux));
      updateAllChartColors();

      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = "";
      data.slice().reverse().forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${formatTime(r.timestamp)}</td><td>${r.air_temp ?? ''}</td><td>${r.air_humidity ?? ''}</td><td>${r.soil_temp ?? ''}</td><td>${r.soil_percent ?? ''}</td><td>${r.lux ?? ''}</td><td>${r.stable ? 'DA' : 'NE'}</td>`;
        tbody.appendChild(tr);
      });
      const stats = calcStats(data);
      document.getElementById('stats').innerText = JSON.stringify(stats, null, 2);
    }

    document.getElementById('applyFilterBtn').addEventListener('click', loadData);
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const filter = e.target.dataset.filter;
        if (filter) { document.getElementById('whereInput').value = filter; }
      });
    });
    document.getElementById('dateRangeBtn').addEventListener('click', () => {
        const t = new Date(), p = new Date(); p.setDate(t.getDate() - 30);
        const f = d => d.toISOString().split('T')[0];
        document.getElementById('whereInput').value = `timestamp BETWEEN '${f(p)}' AND '${f(t)}'`;
    });

    const btnDeleteRows = document.getElementById('btnDeleteRows');
    if (btnDeleteRows) {
        btnDeleteRows.addEventListener('click', async () => {
            const inputEl = document.getElementById('deleteIdsInput');
            const statusEl = document.getElementById('deleteStatus');
            if (!inputEl || !statusEl) return;
            const input = inputEl.value.trim();
            if (!input) { statusEl.innerText = "Unesite ID-eve za brisanje ili 'all'."; return; }
            if (!confirm(`Jeste li sigurni da želite obrisati ${input === "all" ? "SVE redove" : "ove redove: " + input}?`)) return;
            try {
                const res = await fetch('/api/logs/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: input }) });
                const data = await res.json();
                statusEl.innerText = data.ok ? `Obrisano: ${data.deleted === "all" ? "svi redovi" : data.deleted + " redova."}` : `Greška: ${data.msg || data.error}`;
                if (data.ok) loadData();
            } catch (e) { statusEl.innerText = "Greška pri brisanju: " + e.message; }
        });
    }

    // Inicijalizacija
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    loadData();
});
</script>

</body>
</html>
