<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Chilli - Svi podaci</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
<div id="theme-switcher">üåô</div>
<div class="container-fluid">
  <a href="/" class="btn btn-outline-secondary mt-3 mb-3">Povratak na glavnu ploƒçu</a>
  <h2 class="mb-4">üìä Svi podaci iz baze</h2>

  <div class="mb-4">
    <label for="whereInput" class="form-label">Filter podataka (SQL WHERE uvjet, npr. <code>soil_percent &gt; 40</code>):</label>
    <div class="input-group">
      <input type="text" id="whereInput" class="form-control" value="" placeholder="npr. air_temp > 25 AND lux < 1000">
      <button id="applyFilterBtn" class="btn btn-primary">Primijeni filter</button>
    </div>
	<small class="form-text text-muted mb-1">Primjeri WHERE uvjeta:</small>
	<div class="d-flex flex-wrap gap-2 mb-3">
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="id &gt; 1000">id &gt; 1000</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="air_temp &gt; 25">air_temp &gt; 25</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="soil_percent &lt; 30">soil_percent &lt; 30</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="lux &lt; 500">lux &lt; 500</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" data-filter="stable = 0">stable = 0</button>
	  <button type="button" class="btn btn-sm btn-outline-secondary example-btn" id="dateRangeBtn">zadnjih 30 dana</button>
	</div>
  </div>

  <canvas id="airTempChart"></canvas>
  <canvas id="airHumidityChart"></canvas>
  <canvas id="soilTempChart"></canvas>
  <canvas id="soilMoistureChart"></canvas>
  <canvas id="luxChart"></canvas>

  <div class="card mb-4">
    <div class="card-body">
      <h5>üìà Statistika</h5>
      <pre id="stats"></pre>
    </div>
  </div>

  <h5 class="mt-3">Brisanje podataka</h5>
  <div class="input-group mb-2">
    <input id="deleteIdsInput" type="text" class="form-control" placeholder="ID-evi npr: 1,2,3 ili 'all'">
    <button class="btn btn-danger" id="btnDeleteRows">Obri≈°i</button>
  </div>
  <div id="deleteStatus" class="text-muted small"></div>

  <h4 class="mt-4">Tablica svih podataka</h4>
  <div class="table-container" style="max-height:60vh; overflow:auto;">
    <table class="table table-striped table-sm">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Vrijeme</th><th>Air T</th><th>Air H</th>
          <th>Soil T</th><th>Soil %</th><th>Lux</th><th>Stable</th>
        </tr>
      </thead>
      <tbody id="logsBody"></tbody>
    </table>
  </div>
</div>

<!-- Uƒçitavanje glavne JS skripte -->
<script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
<!-- Logika specifiƒçna za ovu stranicu -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    let charts = [];

    async function fetchData() {
      const where = document.getElementById('whereInput').value.trim();
      const url = where ? `/api/logs/all?where=${encodeURIComponent(where)}` : '/api/logs/all';
      const r = await fetch(url);
      if (!r.ok) {
          alert("Gre≈°ka pri dohvaƒáanju podataka. Provjerite SQL filter.");
          return [];
      }
      return await r.json();
    }

    function clearCharts() {
      charts.forEach(chart => chart.destroy());
      charts = [];
    }

    function calcStats(data) {
        if (data.length === 0) return {};
      const avg = arr => arr.length > 0 ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
      return {
        air_temp: avg(data.map(r => r.air_temp).filter(v => v!==null)),
        air_humidity: avg(data.map(r => r.air_humidity).filter(v => v!==null)),
        soil_temp: avg(data.map(r => r.soil_temp).filter(v => v!==null)),
        soil_percent: avg(data.map(r => r.soil_percent).filter(v => v!==null)),
        lux: avg(data.map(r => r.lux).filter(v => v!==null))
      };
    }

    function makeChart(id, label, labels, data) {
      const ctx = document.getElementById(id).getContext('2d');
      const chart = new Chart(ctx, {
        type:'line',
        data:{
          labels:labels,
          datasets:[{label:label, data:data, tension:0.2, fill:false}]
        },
        options:{ responsive:true, maintainAspectRatio:false }
      });
      charts.push(chart);
      if (window.registerChart) {
          window.registerChart(chart);
      }
    }

    async function loadData() {
      const data = await fetchData();
      clearCharts();

      const labels = data.map(r => window.formatTime(r.timestamp));

      makeChart('airTempChart', 'Air Temperature (¬∞C)', labels, data.map(r => r.air_temp));
      makeChart('airHumidityChart', 'Air Humidity (%)', labels, data.map(r => r.air_humidity));
      makeChart('soilTempChart', 'Soil Temperature (¬∞C)', labels, data.map(r => r.soil_temp));
      makeChart('soilMoistureChart', 'Soil Moisture (%)', labels, data.map(r => r.soil_percent));
      makeChart('luxChart', 'Lux', labels, data.map(r => r.lux));

      if (window.updateAllChartColors) {
          window.updateAllChartColors();
      }

      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = "";
      data.slice().reverse().forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${window.formatTime(r.timestamp)}</td>
          <td>${r.air_temp ?? ''}</td>
          <td>${r.air_humidity ?? ''}</td>
          <td>${r.soil_temp ?? ''}</td>
          <td>${r.soil_percent ?? ''}</td>
          <td>${r.lux ?? ''}</td>
          <td>${r.stable ? 'DA' : 'NE'}</td>`;
        tbody.appendChild(tr);
      });

      const stats = calcStats(data);
      document.getElementById('stats').innerText = JSON.stringify(stats, null, 2);
    }

    window.loadData = loadData;

    document.getElementById('applyFilterBtn').addEventListener('click', loadData);

    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const filter = e.target.dataset.filter;
        if (filter) {
            document.getElementById('whereInput').value = filter;
        }
      });
    });

    document.getElementById('dateRangeBtn').addEventListener('click', () => {
        const t = new Date(), p = new Date();
        p.setDate(t.getDate() - 30);
        const f = d => d.toISOString().split('T')[0];
        document.getElementById('whereInput').value = `timestamp BETWEEN '${f(p)}' AND '${f(t)}'`;
    });

    loadData();
});
</script>

</body>
</html>
