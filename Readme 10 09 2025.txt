# ğŸŒ± Cher â€“ Sustav za praÄ‡enje vlage tla i okoliÅ¡a

Ovo je moj **Raspberry Pi projekt** za praÄ‡enje i automatizaciju uvjeta rasta biljaka.  
Sustav mjeri temperaturu zraka, vlagu zraka, temperaturu tla i vlagu tla, sprema podatke u SQLite bazu i omoguÄ‡ava pregled rezultata preko web suÄelja.

---

## ğŸ“‚ Struktura projekta

cher/
â”œâ”€â”€ logger.py # Glavni logger â€“ pokreÄ‡e mjerenja u petlji i sprema rezultate u bazu
â”œâ”€â”€ sensors.py # Funkcije za Äitanje senzora (DHT22, DS18B20, ADS1115)
â”œâ”€â”€ relays.py # Funkcije za upravljanje relejima (ON/OFF, testiranje)
â”œâ”€â”€ database.py # Inicijalizacija baze i funkcije za Äitanje/brisanje podataka
â”œâ”€â”€ config.py # Centralna konfiguracija (GPIO pinovi, putanje, I2C setup)
â”œâ”€â”€ webserver.py # Flask webserver za pregled podataka i kontrolu sustava
â”œâ”€â”€ templates/
â”‚ â””â”€â”€ index.html # Glavno web suÄelje s grafom, tablicom i kontrolama
â”œâ”€â”€ soil_calibration.json # Kalibracija senzora vlage (dry_v, wet_v u voltima)
â”œâ”€â”€ logger_status.txt # Informacija o stanju loggera (RUNNING since..., PID=...)
â”œâ”€â”€ logger_run.log # Log zapis mjerenja i greÅ¡aka loggera
â””â”€â”€ sensors.db # SQLite baza s mjerenjima


---

## âš™ï¸ Funkcionalnosti

- **Logger (`logger.py`)**
  - `run` â€“ pokreÄ‡e mjerenja u petlji (default svakih 20 min).
  - `run_first` â€“ pokreÄ‡e mjerenja s punom inicijalizacijom (koristi se kada prvi put pokreÄ‡eÅ¡ logger ili kad Å¾eliÅ¡ "hladni start").
  - Sprema podatke u `sensors.db` i opcionalno snima fotografiju.
  - PiÅ¡e logove u `logger_run.log` i status (`PID` i vrijeme pokretanja) u `logger_status.txt`.

- **Senzori (`sensors.py`)**
  - `read_ds18b20_temp()` â€“ vraÄ‡a temperaturu tla.
  - `read_soil_raw_fresh()` â€“ oÄitava kapacitivni senzor vlage tla (ADS1115) svaki put kao "prvo mjerenje".
  - `read_soil_percent()` â€“ vraÄ‡a vlagu tla u postocima koristeÄ‡i kalibraciju u voltima (`dry_v`, `wet_v`).
  - `test_ads()`, `test_dht()`, `test_ds18b20()` â€“ ruÄno testiranje senzora.
  - `calibrate_ads(dry=True|wet=True)` â€“ spremanje novih kalibracijskih vrijednosti u `soil_calibration.json`.

- **Relays (`relays.py`)**
  - `set_relay_state(relay, state)` â€“ ukljuÄivanje/iskljuÄivanje releja (LOW-trigger logika).
  - `get_relay_state(relay)` â€“ vraÄ‡a trenutno stanje releja.
  - `test_relays()` â€“ prolazi kroz ON/OFF kombinacije releja.

- **Baza (`database.py`)**
  - Sprema mjerenja: vrijeme, temp/humidity zraka, temp tla, raw vrijednosti, voltaÅ¾u i postotak vlage tla.
  - `delete_sql_data(ids, delete_all)` â€“ brisanje zapisa po ID-u, rasponima (3-13) ili brisanje svih zapisa uz potvrdu.
  - `get_sql_data()` â€“ ispis svih zapisa u terminal.

- **Web suÄelje (`webserver.py`)**
  - Pregled posljednjih mjerenja u tablici.
  - Graf sa serijama: temperatura zraka, vlaga zraka, temperatura tla i vlaga tla.
  - RuÄno Äitanje senzora na zahtjev.
  - Upravljanje relejima.
  - Dugmad za pokretanje loggera (`RUN` i `RUN_FIRST`) i pregled logova (`logger_run.log`).
  - Prikaz kada je logger zadnji put pokrenut (`logger_status.txt`).

---

## ğŸ”§ Instalacija

```bash
# 1. Kloniraj projekt ili kopiraj ga na Raspberry Pi
cd ~/cher

# 2. Napravi i aktiviraj virtualno okruÅ¾enje
python3 -m venv .venv
source .venv/bin/activate

# 3. Instaliraj potrebne pakete
pip install flask adafruit-circuitpython-ads1x15 adafruit-circuitpython-dht RPi.GPIO


ğŸš€ Pokretanje

Logger (background):

python3 logger.py run


ili za hladni start:

python3 logger.py run_first


Webserver:

python3 webserver.py


Zatim otvori u pregledniku:
http://192.168.x.x:5000

ğŸ§ª Kalibracija senzora vlage tla

Pusti senzor da se potpuno osuÅ¡i â†’ pokreni:

python3 logger.py calibrate_ads --dry


Potopi senzor u vodu â†’ pokreni:

python3 logger.py calibrate_ads --wet

ğŸ›  Debug i logovi

Sve greÅ¡ke loggera piÅ¡u se u logger_run.log.

Ako logger prestane raditi, provjeri zadnje retke loga:

tail -n 50 logger_run.log

â„¹ï¸ Napomene

ADS1115 se svaki put inicijalizira "fresh" kako bi se izbjeglo Äitanje krivih vrijednosti kod viÅ¡e uzastopnih oÄitanja.

Projekt trenutno koristi Flask development server â€“ za produkciju je preporuÄljivo pokrenuti preko gunicorn + systemd servisa.

Sve vrijednosti u bazi su zaokruÅ¾ene na 3 decimale (osim RAW vrijednosti koja je integer).